#include <iostream>
#include <thread>
#include "sinks/ConsoleSinkImpl.hpp"
#include "sinks/FileSinkImpl.hpp"
#include "sinks/ILogSink.hpp"
#include "LogManager.hpp"
#include "LogMessage.hpp"
#include "telemetry/SomeIPTelemetrySourceImpl.hpp"
#include "Formatter.hpp"
#include "ThreadPool.hpp"
#include<nlohmann_json/json.hpp>

int main()
{
    LogManager logger(2, 10);

    logger.add_sink(std::make_unique<ConsoleSinkImpl>());
    logger.add_sink(std::make_unique<FileSinkImpl>("logs.txt"));

    auto &client = SomeIPTelemetrySourceImpl::instance();

    if (!client.openSource())
    {
        std::cout << "Failed to open telemetry source!" << std::endl;
        return -1;
    }

    if (!client.start())
    {
        std::cout << "Failed to start telemetry client!" << std::endl;
        return -1;
    }

    std::cout << "Telemetry client started successfully!" << std::endl;

    for (int i = 0; i < 11; ++i)
    {
        std::string value;

        if (client.readSource(value))
        {
            auto log_msg = Formatter<CPU_policy>::format(value);

            if (log_msg.has_value())
            {
                logger << LogMessage(log_msg.value());
            }
            else
            {
                std::cout << "Failed to parse telemetry data." << std::endl;
            }
        }
        else
        {
            std::cout << "No data available from telemetry source." << std::endl;
        }

        std::this_thread::sleep_for(std::chrono::seconds(1));
    }

    logger.write();

    std::cout << "Telemetry logs sent to console and file.\n";

    return 0;
}
